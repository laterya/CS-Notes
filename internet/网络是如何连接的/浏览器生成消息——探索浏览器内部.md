# 浏览器生成消息——探索浏览器内部

## 生成HTTP请求消息

### 网址相关

- 网址，准确来说应该叫URL
- 有各种各样的URL用来判断使用不同的浏览器功能
- URL开头的文字，即“http:”“ftp:”“file:”“mailto:”这部分文字都表示浏览器应当使用的访问方法

### 解析URL

浏览器要做的第一步工作就是对URL进行解析，从而生成发送给Web服务器的请求消息

![image-20220509162323544](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220509162323544.png)

### 省略文件名的情况

- 以“/”结尾代表/dir/后面本来应该有的文件名被省略了
- 会在服务器上事先设置好文件名省略时要访问的默认文件名。这个设置根据服务器不同而不同，大多数情况下是index.html或者default.htm之类的文件名
- 当没有路径名时，就代表访问根目录下事先设置的默认文件

### HTTP的基本思路

解析完URL之后，我们就知道应该要访问的目标在哪里了，接下来，浏览器会使用HTTP协议来访问Web服务器。

- HTTP协议定义了客户端和服务器之间交互的消息内容和步骤
  1. 首先，客户端会向服务器发送请求消息，请求消息中包含的内容是“对什么”和“进行怎样的操作”两个部分。其中相当于“对什么”的部分称为URI，进行怎样的操作”的部分称为方法。方法表示需要让Web服务器完成怎样的工作。
  2. 收到请求消息之后，Web服务器会对其中的内容进行解析。并根据这些要求来完成自己的工作，然后将结果存放在响应消息中。在响应消息的开头有一个状态码，它用来表示操作的执行结果是成功还是发生了错误
  3. 响应消息会被发送回客户端，客户端收到之后，浏览器会从消息中读出所需的数据并显示在屏幕上。到这里，HTTP的整个工作就完成了。

### 生成HTTP请求消息

对URL进行解析之后，浏览器确定了Web服务器和文件名，接下来就是根据这些信息来生成HTTP请求消息了。实际上，HTTP消息在格式上是有严格规定的，因此浏览器会按照规定的格式来生成请求消息

![image-20220509163152523](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220509163152523.png)

### 发送请求后会收到响应

- 当我们将上述请求消息发送出去之后，Web服务器会返回响应消息。

- 响应消息的格式以及基本思路和请求消息是相同的，差别只在第一行上。在响应消息中，第一行的内容为状态码和响应短语，用来表示请求的执行结果是成功还是出错。

- 1条请求消息中只能写1个URI。如果需要获取多个文件，必须对每个文件单独发送1条请求。

## 向DNS服务器查询Web服务器的IP地址

生成HTTP消息之后，接下来我们需要委托操作系统将消息发送给Web服务器。尽管浏览器能够解析网址并生成HTTP消息，但它本身并不具备将消息发送到网络中的功能，因此这一功能需要委托操作系统来实现

### IP地址基本知识

- TCP/IP的结构就是由一些小的子网，通过路由器连接起来组成一个大的网络
- 在网络中，所有的设备都会被分配一个地址。由网络号和主机号组成，地址的整体称为IP地址。
- 通过IP地址我们可以判断出访问对象服务器的位置，从而将消息发送到服务器。

![image-20220509163839216](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220509163839216.png)

- 实际的IP地址是一串32比特的数字，按照8比特（1字节）为一组分成4组，分别用十进制表示然后再用圆点隔开。![image-20220509163953155](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220509163953155.png)

  ![image-20220509164039502](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220509164039502.png)

**IP地址的主机号**

**全0：表示整个子网**

**全1：表示向子网上所有设备发送包，即“广播”**

### Socket库提供查询IP地址的功能

对于DNS服务器，我们的计算机上一定有相应的DNS客户端，而相当于DNS客户端的部分称为DNS解析器，或者简称解析器。通过DNS查询IP地址的操作称为域名解析，因此负责执行解析（resolution）这一操作的就叫解析器（resolver）了。

- 解析器实际上是一段程序，它包含在操作系统的Socket库中
- 库就是一堆通用程序组件的集合，其他的应用程序都需要使用其中的组件。Sockett库是用于调用网络功能的程序组件集合。

### 通过解析器向DNS服务器发出查询

**根据域名查询IP地址时，浏览器会使用Socket库中的解析器。**

解析器的用法非常简单。Socket库中的程序都是标准组件，只要从应用程序中进行调用就可以了

![image-20220509164831591](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220509164831591.png)

调用解析器后，解析器会向DNS服务器发送查询消息，然后DNS服务器会返回响应消息。响应消息中包含查询到的IP地址，**解析器会取出IP地址，并将其写入浏览器指定的内存地址中。**

### 解析器的内部原理

调用解析器是计算机内部的工作流程：

![image-20220509165036676](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220509165036676.png)

由于调用了其他程序，原本运行的程序进入暂停状态，而被调用的程序开始运行，这就是“控制流程转移”

## 全世界DNS服务器的大接力

### DNS服务器的基本工作

**DNS服务器的基本工作就是接收来自客户端的查询消息，然后根据消息的内容返回响应。**

客户端的查询消息包含以下三种：

- 域名
- Class：设计DNS考虑到互联网以外的网络，用以识别网络的信息，如今Class的值永远是代表互联网的IN
- 记录类型：表示域名对应何种类型的记录。对于不同的记录类型，服务器向客户端返回的信息也会不同
- ![image-20220510195510403](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220510195510403.png)

DNS服务器会从域名与IP地址的对照表中查找相应的记录，并返回IP地址。

### 域名的层次结构

在域名中，越靠右的位置表示其层级越高。

一个域的信息是作为一个整体存放在DNS服务器中的，不能将一个域拆开来存放在多台DNS服务器中

### 寻找相应的DNS服务器并获取IP地址

寻找要访问的Web服务器的信息所在的DNS服务器顺序：

1. 将负责管理下级域的DNS服务器的IP地址注册到它们的上级DNS服务器中，然后上级DNS服务器的IP地址再注册到更上一级的DNS服务器中，以此类推
2. 这样，就可以通过上级DNS服务器查询出下级DNS服务器的IP地址，也就可以向下级DNS服务器发送查询请求了。
3. ![image-20220510200636057](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220510200636057.png)

### 通过缓存加快DNS服务器的响应

- 现实中上级域和下级域有可能共享同一台DNS服务器。
- 有时候并不需要从最上级的根域开始查找，因为DNS服务器有一个缓存[插图]功能，可以记住之前查询过的域名。如果要查询的域名和相关信息已经在缓存中，那么就可以直接返回响应，接下来的查询可以从缓存的位置开始向下进行。
- 当要查询的域名不存在时，“不存在”这一响应结果也会被缓存。这样，当下次查询这个不存在的域名时，也可以快速响应。
- DNS服务器中保存的信息都设置有一个有效期，当缓存中的信息超过有效期后，数据就会从缓存中删除。
- 对查询进行响应时，DNS服务器也会告知客户端这一响应的结果是来自缓存中还是来自负责管理该域名的DNS服务器。

## 委托协议栈发送消息

### 数据手法操作概览

1. 创建套接字（创建套接字阶段）

2. 将管道连接到服务器端的套接字上（连接阶段）
3. 收发数据（通信阶段）
4. 断开管道并删除套接字（断开阶段）

向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调用Socket库中的程序组件。

数据通过类似管道的结构来流动![image-20220510201138650](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220510201138650.png)

- 在进行收发数据操作之前，双方需要先建立起这条管道
  1. 服务器一方先创建套接字，然后等待客户端向该套接字连接管道
  2. 当服务器进入等待状态时，客户端也会先创建一个套接字，然后从该套接字延伸出管道，最后管道连接到服务器端的套接字上。
  3. 当双方的套接字连接起来之后，通信准备就完成了。
- 当数据全部发送完毕之后，连接的管道将会被断开。管道在连接时是由客户端发起的，但在断开时可以由客户端或服务器任意一方发起其中一方断开后，另一方也会随之断开，当管道断开后，套接字也会被删除。到此为止，通信操作就结束了。

### 创建套接字阶段

- 客户端创建套接字的操作：只要调用Socket库中的socket程序组件就可以了
- 调用socket之后，控制流程会转移到socket内部并执行创建套接字的操作，完成之后控制流程又会被移交回应用程序
- 套接字创建完成后，协议栈会返回一个描述符，应用程序会将收到的描述符存放在内存中。
- 应用程序是通过“描述符”这一类似号码牌的东西来识别套接字的。
-  客户端和服务器之间收发数据操作的情形：![image-20220510202015455](C:\Users\yuxia\AppData\Roaming\Typora\typora-user-images\image-20220510202015455.png)

### 连接阶段

- 委托协议栈将客户端创建的套接字与服务器那边的套接字连接起来。应用程序通过调用Socket库中的名为connect的程序组件来完成这一操作。
- 当调用connect时，需要指定描述符、服务器IP地址和端口号这3个参数
- 描述符：应用程序用来识别套接字的机制
- IP地址和端口号：客户端和服务器之间用来识别对方套接字的机制
- 连接操作的对象是某个具体的套接字，因此必须要识别到具体的套接字才行，当同时指定IP地址和端口号时，就可以明确识别出某台具体的计算机上的某个具体的套接字。
- 如果说描述符是用来在一台计算机内部识别套接字的机制，那么端口号就是用来让通信的另一方能够识别出套接字的机制
- 服务器上所使用的端口号是根据应用的种类事先规定好的，仅此而已。比如Web是80号端口，电子邮件是25号端口

### 通信阶段

通过Socket库委托协议栈来完成这个操作。这个操作需要使用write这个程序组件

1. 应用程序需要在内存中准备好要发送的数据。根据用户输入的网址生成的HTTP请求消息就是我们要发送的数据。
2. 当调用write时，需要指定描述符和发送数据，然后协议栈就会将数据发送到服务器。
3. 服务器执行接收操作，解析收到的数据内容并执行相应的操作，向客户端返回响应消息
4. 当消息返回后，需要执行的是接收消息的操作。接收消息的操作是通过Socket库中的read程序组件委托协议栈来完成的
5. 调用read时需要指定用于存放接收到的响应消息的内存地址，这一内存地址称为接收缓冲区。由于接收缓冲区是一块位于应用程序内部的内存空间，因此当消息被存放到接收缓冲区中时，就相当于已经转交给了应用程序。

### 断开阶段

调用Socket库的close程序组件进入断开阶段，最终，连接在套接字之间的管道会被断开，套接字本身也会被删除。

1. Web使用的HTTP协议规定，当Web服务器发送完响应消息之后，应该主动执行断开操作，因此Web服务器会首先调用close来断开连接。
2. 断开操作传达到客户端之后，客户端的套接字也会进入断开阶段。
3. 当浏览器调用read执行接收数据操作时，read会告知浏览器收发数据操作已结束，连接已经断开。浏览器得知后，也会调用close进入断开阶段。

HTTP协议将HTML文档和图片都作为单独的对象来处理，每获取一次数据，就要执行一次连接、发送请求消息、接收响应消息、断开的过程。
